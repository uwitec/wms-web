<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.teeny.wms.core.repository.RecBillRepository">
    <cache/>

    <select id="countByWarehousId" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_RecBill p
        <where>
            <if test="warehouseId != 0">
                S_id=#{warehouseId}
            </if>
        </where>
    </select>

    <select id="getUnitList" resultType="com.teeny.wms.dto.CommonDTO">
        SELECT DISTINCT
            b.c_id AS id,
            c.name AS name
        FROM ${account}.dbo.pda_RecBill b
            LEFT JOIN ${account}.dbo.pda_clients c ON b.c_id = c.c_id
        <if test="sId != 0">
            WHERE b.s_id = #{sId}
        </if>
    </select>

    <select id="getOrderList" resultType="com.teeny.wms.dto.RecBillDTO">
        SELECT
            r.billid       AS orderId,
            r.billnumber   AS billNo,
            r.e_id         AS buyerId,
            e.name         AS buyer,
            CASE r.billstates
            WHEN 10
                THEN '未处理'
            ELSE '已审核' END AS status
        FROM ${account}.dbo.pda_RecBill r
            LEFT JOIN ${account}.dbo.pda_employees e ON r.e_id = e.e_id
        WHERE r.c_id = #{unitId}
    </select>

    <select id="getOrder" resultType="com.teeny.wms.dto.RecBillDTO">
        SELECT
            r.billid       AS orderId,
            r.billnumber   AS billNo,
            r.e_id         AS buyerId,
            CASE r.billstates
            WHEN 10
                THEN '未处理'
            ELSE '已审核' END AS status,
            e.name         AS buyer
        FROM ${account}.dbo.pda_RecBill r
            LEFT JOIN ${account}.dbo.pda_employees e ON r.e_id = e.e_id
        WHERE r.billid = #{orderId}
    </select>

    <select id="getGoodsByBillId" resultType="com.teeny.wms.dto.GoodsDTO">
        SELECT
            d.smb_id     AS id,
            b.billnumber AS billNo,
            d.TaxPrice   AS retailPrice,
            d.Yqty       AS amount,
            c.name       AS manufacturer,
            d.Batchno    AS lotNo,
            p.name       AS goodsName,
            p.standard   AS specification,
            d.Validdate  AS validityDate,
            p.makearea   AS produceArea,
            d.DealStates AS status
        FROM ${account}.dbo.pda_RecBill_D d
            LEFT JOIN ${account}.dbo.pda_RecBill b ON b.billid = d.bill_id
            LEFT JOIN ${account}.dbo.pda_Products p ON d.p_id = p.p_id
            LEFT JOIN ${account}.dbo.pda_clients c ON c.c_id = d.Supplier_id
        WHERE b.billid = #{orderId}
    </select>

    <insert id="addData">
        INSERT INTO ${account}.dbo.pda_RecBill_D (bill_id, p_id, MakeDate, Validdate, Batchno, Yqty, EligibleQty, TaxPrice, TaxTotal, CostPrice, CostTotal, S_id, Location_id, Supplier_id, DealStates, pdastates, original_id)
            SELECT
                d.bill_id,
                d.p_id,
                d.MakeDate,
                #{validityDate},
                #{lotNo},
                d.Yqty,
                #{amount},
                d.TaxPrice,
                d.TaxTotal,
                d.CostPrice,
                d.CostTotal,
                d.S_id,
                d.Location_id,
                d.Supplier_id,
                1,
                1,
                d.original_id
            FROM ${account}.dbo.pda_RecBill_D d
            WHERE d.smb_id = #{id}
    </insert>

    <select id="getOrderBillWithUnitId" resultType="com.teeny.wms.dto.CommonDTO">
        SELECT billid AS id, billnumber AS name
        FROM ${account}.dbo.pda_RecBill WHERE c_id=#{unitId}
        <if test="sId != 0">
            AND s_id=#{sId}
        </if>
    </select>

</mapper>
