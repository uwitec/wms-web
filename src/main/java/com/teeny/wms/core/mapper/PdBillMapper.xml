<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.teeny.wms.core.repository.PdBillRepository">

    <select id="getGoodsList" resultType="com.teeny.wms.dto.PutawayDTO">
        SELECT TOP ${limit} temp.id,temp.status,temp.location, temp.goodsName,temp.lotNo, temp.produceDate, temp.unit, temp.amount, temp.standard, temp.manufacturers FROM (
        SELECT row_number() OVER(ORDER BY b.pdaInTime DESC ) AS rowid, d.smb_id AS id, d.DealStates AS status, l.loc_name AS location, p.name AS goodsName, d.Batchno AS lotNo, d.MakeDate AS produceDate, p.unit1Name AS unit, d.EligibleQty AS amount, p.standard, p.Factory AS manufacturers FROM #{account}.dbo.pda_PutOnBill_D d
        LEFT JOIN #{account}.dbo.pda_PutOnBill b ON d.bill_id=b.billid
        LEFT JOIN #{account}.dbo.pda_Products p ON d.p_id=p.p_id
        LEFT JOIN #{account}.dbo.pda_location l ON l.l_id=d.Location_id
        <where>
            <if test="billNo != null and billNo != ''">
                b.billnumber=#{billNo}
            </if>
            <if test="type != null">
                AND d.DealStates = #{type}
            </if>
            <if test="locationName != null and locationName != ''">
                AND l.loc_name = #{locationName}
            </if>
            <if test="goods != null and goods != ''">
                AND p.name = #{goods}
            </if>
        </where>
        ) AS temp WHERE rowid > (${page}*${limit});
    </select>

    <select id="getBillCount" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_pdBill b
        LEFT JOIN ${account}.dbo.pda_pdBill_D d ON b.billid=d.bill_id
        LEFT JOIN ${account}.dbo.pda_Products p ON p.p_id=d.p_id
        LEFT JOIN ${account}.dbo.pda_stockArea sa ON sa.sa_id=b.sa_id
        LEFT JOIN ${account}.dbo.pda_Area a ON a.sc_id=b.a_id
        LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
        WHERE
        b.billstates=1 AND b.pdastates = 2
        <if test="type != null and type !=''">
            AND b.pdname = #{type}
        </if>
        <if test="goods != null and goods !=''">
            AND p.name LIKE concat('%',#{goods},'%')
        </if>
        <if test="storageArea != null and storageArea != ''">
            AND sa.name LIKE concat('%',#{storageArea},'%')
        </if>
        <if test="area != null and area != ''">
            AND a.name LIKE concat('%',#{area},'%')
        </if>
        <if test="location != null and location != ''">
            AND l.loc_name LIKE concat('%',#{location},'%')
        </if>
    </select>

    <select id="getBillTotal" resultType="int">
    SELECT count(*) FROM ${account}.dbo.pda_pdBill_D d
    LEFT JOIN ${account}.dbo.pda_pdBill b ON b.billid=d.bill_id
    LEFT JOIN ${account}.dbo.pda_Products p ON d.p_id=p.p_id
    LEFT JOIN ${account}.dbo.pda_stockArea sa ON sa.sa_id=b.sa_id
    LEFT JOIN ${account}.dbo.pda_Area a ON a.sc_id=b.a_id
    LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
    WHERE
        b.billstates=1
    <if test="type != null and type != ''">
        AND b.pdname = #{type}
    </if>
    <if test="goods != null and goods !=''">
        AND p.name LIKE concat('%',#{goods},'%')
    </if>
    <if test="storageArea != null and storageArea != ''">
        AND sa.name LIKE concat('%',#{storageArea},'%')
    </if>
    <if test="area != null and area != ''">
        AND a.name LIKE concat('%',#{area},'%')
    </if>
    <if test="location != null and location != ''">
        AND l.loc_name LIKE concat('%',#{location},'%')
    </if>
</select>

    <select id="getPcount" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_pdBill_D d
            LEFT JOIN ${account}.dbo.pda_pdBill b ON b.billid=d.bill_id
            LEFT JOIN ${account}.dbo.pda_Products p ON d.p_id=p.p_id
            LEFT JOIN ${account}.dbo.pda_stockArea sa ON sa.sa_id=b.sa_id
            LEFT JOIN ${account}.dbo.pda_Area a ON a.sc_id=b.a_id
            LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
        WHERE
            d.billstates = 1 AND d.DealStates = 1
            <if test="type != null and type != ''">
                AND b.pdname = #{type}
            </if>
            <if test="goods != null and goods !=''">
                AND p.name LIKE concat('%',#{goods},'%')
            </if>
            <if test="storageArea != null and storageArea != ''">
                AND sa.name LIKE concat('%',#{storageArea},'%')
            </if>
            <if test="area != null and area != ''">
                AND a.name LIKE concat('%',#{area},'%')
            </if>
            <if test="location != null and location != ''">
                AND l.loc_name LIKE concat('%',#{location},'%')
            </if>
    </select>

    <select id="getPtotal" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_pdBill_D d
        LEFT JOIN ${account}.dbo.pda_pdBill b ON b.billid=d.bill_id
        LEFT JOIN ${account}.dbo.pda_Products p ON d.p_id=p.p_id
        LEFT JOIN ${account}.dbo.pda_stockArea sa ON sa.sa_id=b.sa_id
        LEFT JOIN ${account}.dbo.pda_Area a ON a.sc_id=b.a_id
        LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
        WHERE
        d.billstates = 1
        <if test="type != null and type != ''">
            AND b.pdname = #{type}
        </if>
        <if test="goods != null and goods !=''">
            AND p.name LIKE concat('%',#{goods},'%')
        </if>
        <if test="storageArea != null and storageArea != ''">
            AND sa.name LIKE concat('%',#{storageArea},'%')
        </if>
        <if test="area != null and area != ''">
            AND a.name LIKE concat('%',#{area},'%')
        </if>
        <if test="location != null and location != ''">
            AND l.loc_name LIKE concat('%',#{location},'%')
        </if>

    </select>

    <select id="getStoreInventoryList" resultType="com.teeny.wms.dto.StoreInventoryDTO">
        SELECT d.smb_id AS id, p.name AS goodsName, l.loc_name AS location,d.EligibleQty AS countInBill, d.pdQty AS inventroyCount, p.unit1Name AS unit, c.name AS manufacturer
        FROM pda_pdBill_D d
        LEFT JOIN pda_pdBill b ON b.billid=d.bill_id
        LEFT JOIN pda_Products p ON d.p_id=p.p_id
        LEFT JOIN pda_stockArea sa ON sa.sa_id=b.sa_id
        LEFT JOIN pda_clients c ON c.c_id=d.Supplier_id
        LEFT JOIN pda_Area a ON a.sc_id=b.a_id
        LEFT JOIN pda_location l ON l.l_id=d.Location_id
        WHERE
          d.DealStates = 0
        <if test="type != null and type != ''">
            AND b.pdname = #{type}
        </if>
        <if test="goods != null and goods !=''">
            AND p.name LIKE concat('%',#{goods},'%')
        </if>
        <if test="storageArea != null and storageArea != ''">
            AND sa.name LIKE concat('%',#{storageArea},'%')
        </if>
        <if test="area != null and area != ''">
            AND a.name LIKE concat('%',#{area},'%')
        </if>
        <if test="location != null and location != ''">
            AND l.loc_name LIKE concat('%',#{location},'%')
        </if>
    </select>

    <!--////////////////////单品盘点////////////////////-->

    <select id="countProductInventory" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_kcpdBill_D d
            LEFT JOIN ${account}.dbo.pda_Products p ON p.p_id=d.p_id
            LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
            <where>
                <if test="product != null and product != ''">
                    p.name LIKE concat('%', #{product}, '%')
                </if>
                <if test="location != null and location != ''">
                    AND l.loc_name LIKE concat('%', #{location}, '%')
                </if>
            </where>
    </select>

    <select id="getProductsInventoryList" resultType="com.teeny.wms.dto.ProductsInventoryDTO">

        SELECT TOP 5 temp.storehouse_id AS id,
            temp.name AS goodsName,
            temp.loc_name AS location,
            temp.Batchno AS lotNo,
            temp.quantity AS amount,
            temp.Validdate AS validateDate,
            temp.standard AS standard,
            temp.Factory AS manufacturer,
            temp.pdastates AS status FROM (
        SELECT row_number() OVER(ORDER BY b.pdaInTime DESC) AS rowid, d.storehouse_id AS id,
            p.name AS goodsName,
            l.loc_name AS location,
            d.Batchno AS lotNo,
            d.quantity AS amount,
            d.Validdate AS validateDate,
            p.standard AS standard,
            p.Factory AS manufacturer,
            d.pdastates AS status
            FROM ${account}.dbo.pda_kcpdBill_D d
            LEFT JOIN ${account}.dbo.pda_Products p ON p.p_id=d.p_id
            LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
            <where>
                <if test="product != null and product != ''">
                    p.name LIKE concat('%', #{product}, '%')
                </if>
                <if test="location != null and location != ''">
                    AND l.loc_name LIKE concat('%', #{location}, '%')
                </if>
            </where>
        ) AS temp WHERE rowid > (${page}*${limit});
    </select>



</mapper>
