<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.teeny.wms.core.repository.PdBillRepository">

    <select id="getBillCount" resultType="int">

        SELECT count(*) total FROM ${account}.dbo.pda_pdBill b
        WHERE b.billid IN (
        SELECT d.bill_id FROM ${account}.dbo.pda_pdBill_D d
        <where>
            <if test="goodsId != 0">
                d.p_id = #{goodsId}
            </if>
            <if test="locationId != 0">
                AND d.Location_id = #{locationId}
            </if>
        </where>
        ) AND b.billstates = #{type} AND b.pdastates = 2
        <if test="pdname != null and pdname != ''">
            b.pdname =#{pdType}
        </if>
        <if test="saId != 0">
            AND b.sa_id = #{saId}
        </if>

    </select>

    <select id="getBillTotal" resultType="int">
        SELECT count(*) total FROM ${account}.dbo.pda_pdBill b
        WHERE b.billid IN (
        SELECT d.bill_id FROM ${account}.dbo.pda_pdBill_D d
        <where>
            <if test="goodsId != 0">
                d.p_id = #{goodsId}
            </if>
            <if test="locationId != 0">
                AND d.Location_id = #{locationId}
            </if>
        </where>
        ) AND b.billstates = #{type}
        <if test="pdname != null and pdname != ''">
            b.pdname =#{pdType}
        </if>
        <if test="saId != 0">
            AND b.sa_id = #{saId}
        </if>
    </select>

    <select id="getPcount" resultType="int">
        SELECT count(*) total FROM ${account}.dbo.pda_pdBill_D d LEFT JOIN ${account}.dbo.pda_pdBill b ON d.bill_id=b.billid
        WHERE b.billstates = #{type} AND b.pdastates = 2
        <if test="saId != 0">
            AND b.sa_id = #{saId}
        </if>
        <if test="areaId != 0">
            AND b.a_id = #{areaId}
        </if>
        <if test="locationId != 0">
            AND d.Location_id = #{locationId}
        </if>
        <if test="goodsId != 0">
            AND d.p_id = #{goodsId}
        </if>
    </select>

    <select id="getPtotal" resultType="int">
        SELECT count(*) total FROM ${account}.dbo.pda_pdBill_D d LEFT JOIN ${account}.dbo.pda_pdBill b ON d.bill_id=b.billid
            WHERE b.billstates = #{type}
            <if test="saId != 0">
                AND b.sa_id = #{saId}
            </if>
            <if test="areaId != 0">
                AND b.a_id = #{areaId}
            </if>
            <if test="locationId != 0">
                AND d.Location_id = #{locationId}
            </if>
            <if test="goodsId != 0">
                AND d.p_id = #{goodsId}
            </if>
    </select>

    <select id="getStoreInventoryList" resultType="com.teeny.wms.dto.StoreInventoryDTO">
        SELECT d.smb_id AS id, p.name AS goodsName, l.loc_name AS location,d.EligibleQty AS countInBill, d.pdQty AS inventroyCount, p.unit1Name AS unit, c.name AS manufacturer
        FROM ${account}.dbo.pda_pdBill_D d
        LEFT JOIN ${account}.dbo.pda_pdBill b ON b.billid=d.bill_id
        LEFT JOIN ${account}.dbo.pda_Products p ON d.p_id=p.p_id
        LEFT JOIN ${account}.dbo.pda_stockArea sa ON sa.sa_id=b.sa_id
        LEFT JOIN ${account}.dbo.pda_clients c ON c.c_id=d.Supplier_id
        LEFT JOIN ${account}.dbo.pda_Area a ON a.sc_id=b.a_id
        LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
        WHERE
          b.pdname = #{pdType} AND d.DealStates = 0
        <if test="saId != 0">
            AND b.sa_id = #{saId}
        </if>
        <if test="areaId != 0">
            AND b.a_id=#{areaId}
        </if>
        <if test="locationId">
            AND d.Location_id = #{locationId}
        </if>
        <if test="goodsId != 0">
            AND d.p_id = #{goodsId}
        </if>
    </select>

    <update id="updateByParam">
        UPDATE ${account}.dbo.pda_pdBill_D SET DealStates = 1
        WHERE Location_id = #{allocationId}
              AND S_id = #{sId}
                <if test="goodsId != 0">
                    AND p_id = #{goodsId}
                </if>
              AND bill_id =
        (SELECT b.billid FROM ${account}.dbo.pda_pdBill b
          WHERE b.pdname = #{span}
              <if test="saId != 0">
                  AND b.sa_id = #{saId}
              </if>
              <if test="areaId != 0">
                  AND b.a_id=#{areaId}
              </if>
          )
    </update>

    <select id="countByParam" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_pdBill_D d LEFT JOIN ${account}.dbo.pda_pdBill b ON d.bill_id=b.billid
        WHERE b.pdname=#{span} AND d.S_id = #{sId}
          <if test="saId != 0">
              AND b.sa_id = #{saId}
          </if>
          <if test="areaId != 0">
              AND b.a_id = #{areaId}
          </if>
          <if test="allocationId != 0">
              AND d.Location_id = #{allocationId}
          </if>
          <if test="goodsId != 0">
              AND d.p_id = #{goodsId}
          </if>
    </select>


    <!--////////////////////单品盘点////////////////////-->

    <select id="countProductInventory" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_kcpdBill_D d
            LEFT JOIN ${account}.dbo.pda_Products p ON p.p_id=d.p_id
            LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
            <where>
                <if test="product != null and product != ''">
                    p.name LIKE concat('%', #{product}, '%')
                </if>
                <if test="location != null and location != ''">
                    AND l.loc_name LIKE concat('%', #{location}, '%')
                </if>
            </where>
    </select>

    <select id="getProductsInventoryList" resultType="com.teeny.wms.dto.ProductsInventoryDTO">

        SELECT  d.storehouse_id AS id,
            p.name AS goodsName,
            l.loc_name AS location,
            d.Batchno AS lotNo,
            d.quantity AS amount,
            d.Validdate AS validateDate,
            p.standard AS standard,
            p.Factory AS manufacturer,
            CASE d.pdastates WHEN 0 THEN '未盘点' ELSE '已盘点' END AS status
            FROM ${account}.dbo.pda_kcpdBill_D d
            LEFT JOIN ${account}.dbo.pda_Products p ON p.p_id=d.p_id
            LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
            WHERE d.ss_id = #{sId} AND d.DealStates = 0
                <if test="product != null and product != ''">
                    p.name LIKE concat('%', #{product}, '%')
                </if>
                <if test="location != null and location != ''">
                    AND l.loc_name LIKE concat('%', #{location}, '%')
                </if>
    </select>


    <update id="updateStatus">
        UPDATE pda_kcpdBill_D SET DealStates = 1,pdastates = 1
        WHERE d.ss_id = #{sId}
        <if test="product != null and product != ''">
            AND p_id IN (SELECT p.p_id FROM pda_Products p LEFT JOIN pda_kcpdBill_D d ON d.p_id=p.p_id
            WHERE p.name LIKE concat('%',#{product},'%'))
        </if>
        <if test="location != null and location != ''">
            AND Location_id IN
            (SELECT l.l_id FROM pda_location l LEFT JOIN pda_kcpdBill_D d1 ON d1.Location_id=l.l_id WHERE l.loc_name LIKE concat('%',#{location},'%'))
        </if>
    </update>



</mapper>
