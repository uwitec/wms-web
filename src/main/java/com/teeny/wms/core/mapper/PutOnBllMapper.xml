<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.teeny.wms.core.repository.PutOnBillRepository">
    <cache />

    <select id="countByWarehousId" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_PutOnBill p
        <where>
            <if test="warehouseId != 0">
                AND s_id=#{warehouseId}
            </if>
        </where>
    </select>


    <select id="getGoodsDetailList" parameterType="string" resultType="com.teeny.wms.dto.PutawayDTO">
      SELECT d.smb_id AS id, d.DealStates AS status, l.loc_name AS location, p.name AS goodsName, d.Batchno AS lotNo, d.MakeDate AS produceDate, p.unit1Name AS unit, d.EligibleQty AS amount, p.standard AS specification, p.Factory AS manufacturers FROM ${account}.dbo.pda_PutOnBill_D d
        LEFT JOIN ${account}.dbo.pda_PutOnBill b ON d.bill_id=b.billid
        LEFT JOIN ${account}.dbo.pda_location l ON l.l_id=d.Location_id
        LEFT JOIN ${account}.dbo.pda_Products p ON p.p_id=d.p_id
        WHERE b.billnumber=#{orderNoId}
        <if test="sId !=0 ">
            AND d.S_id=#{sId}
        </if>
    </select>


    <!--                      更新                             -->


    <update id="updateDetailsStatus">
        UPDATE pda_PutOnBill_D SET DealStates=1
        WHERE bill_id = (SELECT b.billid FROM pda_pdBill b WHERE b.billid=#{orderNoId})
        <if test="allocationId != 0">
            AND Location_id = #{allocationId}
        </if>
        <if test="goodsId != 0">
            AND p_id = #{goodsId}
        </if>
    </update>

    <update id="copyData">
        INSERT INTO ${account}.dbo.pda_PutOnBill_D
        (bill_id,
        p_id,
        MakeDate,
        Validdate,
        Batchno,
        EligibleQty,
        TaxPrice,
        TaxTotal,
        CostPrice,
        CostTotal,
        S_id,
        Location_id,
        Supplier_id,
        InstoreTime,
        LineSort,
        DealStates,
        pdastates)
        SELECT bill_id,p_id,MakeDate,Validdate,Batchno,#{amout},TaxPrice,TaxTotal,CostPrice,CostTotal,S_id,#{allcationId},Supplier_id,InstoreTime,LineSort,1,1
        FROM pda_PutOnBill_D d
        WHERE d.smb_id = #{goodsDetailId}
    </update>

    <insert id="copyDataByParam">
        INSERT INTO ${account}.dbo.pda_PutOnBill_D (bill_id, p_id, MakeDate, Validdate, Batchno, EligibleQty, TaxPrice, TaxTotal, CostPrice, CostTotal, S_id, Location_id, Supplier_id, InstoreTime, LineSort, DealStates, pdastates)
            SELECT d.bill_id,d.p_id,d.MakeDate,d.Validdate,d.Batchno,#{amount},d.TaxPrice,d.TaxTotal,d.CostPrice,d.CostTotal,
                d.S_id,isnull((SELECT l.l_id FROM ${account}.dbo.pda_location l WHERE l.loc_code=#{locationCode}),0),d.Supplier_id,d.InstoreTime,d.LineSort,1,1
            FROM ${account}.dbo.pda_PutOnBill_D d WHERE d.smb_id=#{id}
    </insert>

</mapper>
