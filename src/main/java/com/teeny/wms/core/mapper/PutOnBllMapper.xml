<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.teeny.wms.core.repository.PutOnBillRepository">
    <cache />

    <select id="countByWarehoust" resultType="int">
        SELECT count(*) FROM ${account}.dbo.pda_PutOnBill p
        <where>
            <if test="warehouseId != 0">
                AND s_id=#{warehouseId}
            </if>
        </where>
    </select>


    <select id="getGoodsList" resultType="com.teeny.wms.dto.PutawayDTO">
        SELECT TOP ${limit} temp.id,temp.status,temp.location, temp.goodsName,temp.lotNo, temp.produceDate, temp.unit, temp.amount, temp.standard, temp.manufacturers FROM (
        SELECT row_number() OVER(ORDER BY b.pdaInTime DESC ) AS rowid, d.smb_id AS id, d.DealStates AS status, l.loc_name AS location, p.name AS goodsName, d.Batchno AS lotNo, d.MakeDate AS produceDate, p.unit1Name AS unit, d.EligibleQty AS amount, p.standard, p.Factory AS manufacturers FROM #{account}.dbo.pda_PutOnBill_D d
        LEFT JOIN #{account}.dbo.pda_PutOnBill b ON d.bill_id=b.billid
        LEFT JOIN #{account}.dbo.pda_Products p ON d.p_id=p.p_id
        LEFT JOIN #{account}.dbo.pda_location l ON l.l_id=d.Location_id
        <where>
            <if test="billNo != null and billNo != ''">
                b.billnumber=#{billNo}
            </if>
            <if test="type != null">
                AND d.DealStates = #{type}
            </if>
            <if test="locationName != null and locationName != ''">
                AND l.loc_name = #{locationName}
            </if>
            <if test="goods != null and goods != ''">
                AND p.name = #{goods}
            </if>
        </where>
        ) AS temp WHERE rowid > (${page}*${limit});
    </select>

    <update id="copyData">
        INSERT INTO ${account}.dbo.pda_PutOnBill_D
        (bill_id,
         p_id,
         MakeDate,
         Validdate,
         Batchno,
         EligibleQty,
         TaxPrice,
         TaxTotal,
         CostPrice,
         CostTotal,
         S_id,
         Location_id,
         Supplier_id,
         InstoreTime,
         LineSort,
         DealStates,
         pdastates)
            SELECT bill_id,p_id,MakeDate,Validdate,Batchno,EligibleQty,TaxPrice,TaxTotal,CostPrice,CostTotal,S_id,Location_id,Supplier_id,InstoreTime,LineSort,DealStates,pdastates
            FROM pda_PutOnBill_D d
        WHERE d.smb_id = #{account}
    </update>

    <update id="copyDataByBillId">
        INSERT INTO ${account}.dbo.pda_PutOnBill_D
        (bill_id,
        p_id,
        MakeDate,
        Validdate,
        Batchno,
        EligibleQty,
        TaxPrice,
        TaxTotal,
        CostPrice,
        CostTotal,
        S_id,
        Location_id,
        Supplier_id,
        InstoreTime,
        LineSort,
        DealStates,
        pdastates)
        SELECT bill_id,p_id,MakeDate,Validdate,Batchno,EligibleQty,TaxPrice,TaxTotal,CostPrice,CostTotal,S_id,Location_id,Supplier_id,InstoreTime,LineSort,DealStates,d.pdastates
        FROM pda_PutOnBill_D d
        LEFT JOIN pda_PutOnBill b ON b.billid=d.bill_id
        WHERE b.billid=#{billId}
    </update>

    <select id="countByIdType" resultType="int">
        SELECT * FROM pda_PutOnBill_D d
            LEFT JOIN pda_PutOnBill b ON b.billid=d.bill_id
        WHERE b.billid=(SELECT d1.bill_id FROM pda_PutOnBill_D d1 WHERE d1.smb_id = ${bdId})
        <if test="idType=0">
            AND d.smb_id!=0
        </if>
    </select>

</mapper>
